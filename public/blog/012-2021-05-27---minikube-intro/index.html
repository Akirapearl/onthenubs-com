<!doctype html><html lang=en dir=auto><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="noindex, nofollow"><title>On The Nubs</title>
<meta name=keywords content><meta name=description content="Capitulo #12 (27-5-2021)
Esc√∫chalo aqu√≠.
2021-05-27 - Introducci√≥n a MiniKube
En este episodio hemos hecho una introducci√≥n a MiniKube, una versi√≥n ligera de Kubernetes, ideal para aprender y hacer pruebas en local.
En concreto, hemos convertido una aplicaci√≥n PHP en un contenedor, la hemos desplegado en Docker, y luego en MiniKube.
¬øQu√© son los contenedores?
Paquetes que encapsulan los archivos y recursos de una aplicaci√≥n, junto con las instrucciones para ejecutarla."><meta name=author content="Equipo OnTheNubs"><link rel=canonical href=http://localhost:1313/blog/012-2021-05-27---minikube-intro/><link crossorigin=anonymous href=/assets/css/stylesheet.3a3ced9457ff144d6c9f15e377c1c9d36d17eefd25859713cf31004c92d78c22.css integrity="sha256-OjztlFf/FE1snxXjd8HJ020X7v0lhZcTzzEATJLXjCI=" rel="preload stylesheet" as=style><link rel=icon href=http://localhost:1313/images/favicon.ico><link rel=icon type=image/png sizes=16x16 href=http://localhost:1313/images/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=http://localhost:1313/images/favicon-32x32.png><link rel=apple-touch-icon href=http://localhost:1313/images/apple-touch-icon.png><link rel=mask-icon href=http://localhost:1313/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=http://localhost:1313/blog/012-2021-05-27---minikube-intro/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://localhost:1313/ accesskey=h title="On The Nubs (Alt + H)"><img src=http://localhost:1313/images/OnTheNubs-Web.svg alt aria-label=logo height=30>On The Nubs</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://localhost:1313/programas/caf%C3%A9-onthenubs/ title="‚òïÔ∏è Caf√© OnThenubs"><span>‚òïÔ∏è Caf√© OnThenubs</span></a></li><li><a href=http://localhost:1313/programas/workshop/ title="üõ†Ô∏è Workshop"><span>üõ†Ô∏è Workshop</span></a></li><li><a href=http://localhost:1313/programas/emisi%C3%B3n-pirata/ title="üè¥‚Äç‚ò†Ô∏è Emisi√≥n Pirata"><span>üè¥‚Äç‚ò†Ô∏è Emisi√≥n Pirata</span></a></li><li><a href=http://localhost:1313/etiquetas/ title="üè∑Ô∏è Etiquetas"><span>üè∑Ô∏è Etiquetas</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent"></h1><div class=post-meta>6 min&nbsp;¬∑&nbsp;1098 words&nbsp;¬∑&nbsp;Equipo OnTheNubs</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#2021-05-27---introducci√≥n-a-minikube>2021-05-27 - Introducci√≥n a MiniKube</a><ul><li><a href=#qu√©-son-los-contenedores>¬øQu√© son los contenedores?</a></li><li><a href=#diferencias-entre-contenedores-y-m√°quinas-virtuales>Diferencias entre contenedores y m√°quinas virtuales.</a></li><li><a href=#im√°genes-vs-contenedores-en-ejecuci√≥n>Im√°genes vs. contenedores en ejecuci√≥n</a></li><li><a href=#requisitos>Requisitos</a></li><li><a href=#creando-una-imagen-de-contenedor>Creando una imagen de contenedor</a></li><li><a href=#los-problemas-de-usar-docker-a-pelo>Los problemas de usar Docker &ldquo;a pelo&rdquo;</a></li><li><a href=#desplegando-nuestro-contenedor-en-kubernetes>Desplegando nuestro contenedor en Kubernetes.</a></li><li><a href=#desplegando-nuestra-im√°gen>Desplegando nuestra im√°gen</a></li></ul></li><li><a href=#otros-enlaces-de-inter√©s>Otros enlaces de inter√©s:</a></li></ul></nav></div></details></div><div class=post-content><h1 id=capitulo-12-27-5-2021>Capitulo #12 (27-5-2021)<a hidden class=anchor aria-hidden=true href=#capitulo-12-27-5-2021>#</a></h1><p><a href=https://youtu.be/noeYhRUXrgw>Esc√∫chalo aqu√≠</a>.</p><h2 id=2021-05-27---introducci√≥n-a-minikube>2021-05-27 - Introducci√≥n a MiniKube<a hidden class=anchor aria-hidden=true href=#2021-05-27---introducci√≥n-a-minikube>#</a></h2><p>En este episodio hemos hecho una introducci√≥n a MiniKube, una versi√≥n ligera de Kubernetes, ideal para aprender y hacer pruebas en local.</p><p>En concreto, hemos convertido una aplicaci√≥n PHP en un contenedor, la hemos desplegado en Docker, y luego en MiniKube.</p><h3 id=qu√©-son-los-contenedores>¬øQu√© son los contenedores?<a hidden class=anchor aria-hidden=true href=#qu√©-son-los-contenedores>#</a></h3><p>Paquetes que encapsulan los archivos y recursos de una aplicaci√≥n, junto con las instrucciones para ejecutarla.</p><p>Los contenedores tienen dos principales ventajas:</p><ul><li>Si funciona en local, funciona en producci√≥n. Ya que la configuraci√≥n para ejecutar es la misma.</li><li>Los programas est√°n aislados dentro de su contenedor. Si hackean un contenedor, no tienen acceso inmediato a todo el servidor.</li></ul><h3 id=diferencias-entre-contenedores-y-m√°quinas-virtuales>Diferencias entre contenedores y m√°quinas virtuales.<a hidden class=anchor aria-hidden=true href=#diferencias-entre-contenedores-y-m√°quinas-virtuales>#</a></h3><p>Las m√°quinas virtuales tambi√©n comparten estas ventajas, sin embargo ejecutan un sistema operativo completo, mientras que el contenedor se ejecuta normalmente en el mismo sistema huesped.</p><p>Una m√°quina virtual necesita m√°s recursos.</p><p>Por otro lado, al contener un sistema operativo completo tienen una carga extra de mantenimiento. No solo hay que actualizar y asegurar la aplicaci√≥n, si no todos los binarios que se incluyen en su sistema operativo.</p><h3 id=im√°genes-vs-contenedores-en-ejecuci√≥n>Im√°genes vs. contenedores en ejecuci√≥n<a hidden class=anchor aria-hidden=true href=#im√°genes-vs-contenedores-en-ejecuci√≥n>#</a></h3><p>Primero &ldquo;cocinamos&rdquo; la im√°gen de un contenedor.</p><p>Esa im√°gen la podemos ejecutar varias veces, teniendo varias instancias del mismo programa en ejecuci√≥n.</p><h3 id=requisitos>Requisitos<a hidden class=anchor aria-hidden=true href=#requisitos>#</a></h3><p>Para poder seguir los pasos de la demo, tienes que:</p><ol><li>Activar las instrucciones de virtualizaci√≥n en tu ordenador.</li><li>Instalar <a href=https://www.docker.com/products/docker-desktop>Docker for Desktop</a>.</li><li>Instalar <a href=https://minikube.sigs.k8s.io/docs/start/>Minikube</a>.</li></ol><h3 id=creando-una-imagen-de-contenedor>Creando una imagen de contenedor<a hidden class=anchor aria-hidden=true href=#creando-una-imagen-de-contenedor>#</a></h3><p>En <code>php-container</code> est√° todo lo necesario para construir el contenedor que hemos usado en el cap√≠tulo de hoy.</p><pre tabindex=0><code>$ cd php-container
</code></pre><p>All√≠ encontrar√°s los siguientes archivos:</p><ul><li><strong>index.php</strong>: El programa php.</li><li><strong>Dockerfile</strong>: Las instrucciones para crear y ejecutar el contenedor.</li><li><strong>000-default.conf</strong>: Configuraci√≥n espec√≠fica de apache.</li><li><strong>start-apache.sh</strong>: Un script que iniciar√° nuestra aplicaci√≥n dentro de Apache.</li></ul><p>Con <code>docker build</code> creamos la imagen del contenedor:</p><pre tabindex=0><code>docker build -t my-php-app .
</code></pre><p>Donde <code>-t</code> indica una etiqueta que identificar√° al contenedor.</p><p>Normalmente los contenedores se identifican con el hash sha256 de su contenido. Es un n√∫mero largo y dif√≠cil de memorizar, por lo que las etiquetas hacen esta tecnolog√≠a un poco m√°s apta para humanos.</p><p>Con <code>docker run</code> podemos ejecutar nuestro contenedor:</p><pre tabindex=0><code>docker run -p80:80 -it --rm --name my-running-app my-php-app
</code></pre><p>La opci√≥n <code>-p80:80</code> mapea el puerto 80 del contenedor con el de nuestra m√°quina local. Accediendo a localhost:80 accederemos a la app del contenedor.</p><p>Con <code>-it</code> iniciamoss el proceso en modo de consola interactivo. No es necesario, creo, pero en el ejemplo que he usado lo pon√≠a. Funciona, as√≠ que no he probado a quitarlo :).</p><p>El flag <code>--rm</code> (cleanup) borrar√° todos los recursos asociados al contenedor cuando lo paremos. Siendo un contenedor de pruebas, nos evita hacer limpieza entre prueba y prueba.</p><p>Con <code>--name</code> indicamos c√≥mo queremos identificar al nuevo contenedor en ejecuci√≥n. Como podemos ejecutar la misma imagen varias veces a la vez, podemos tener varias versiones numeradas &ldquo;-01&rdquo; para difefenciarlas.</p><p>Por √∫ltimo <code>my-php-app</code> es el nombre de la imagen a ejecutar.</p><h3 id=los-problemas-de-usar-docker-a-pelo>Los problemas de usar Docker &ldquo;a pelo&rdquo;<a hidden class=anchor aria-hidden=true href=#los-problemas-de-usar-docker-a-pelo>#</a></h3><p>Con las instrucciones anteriores ya lo tenemos. Accedemos a <code>localhost:80</code> y vemos nuestra aplicaci√≥n ejecut√°ndose.</p><p>Pero esto no funcionar√° bien para una aplicaci√≥n compleja.</p><p>Una aplicaci√≥n compleja puede estar formada por cientos de contenedores, que tendremos que coordinar a trav√©s de varios servidores. Para complicar m√°s las cosas, cada contenedor tiene su propia direcci√≥n IP.</p><p>¬øY si un contenedor falla? ¬øTenemos que apagarlo y encenderlo manualmente?</p><p>Para eso tenemos ¬°Kubernetes! (y otros <strong>orquestradores de contenedores</strong>).</p><p>A Kubernetes le damos nuestro estado deseado: &ldquo;Quiero 3 servidores web, un balanceador de carga, dos bases de datos‚Ä¶&rdquo;. Y el orquestrador se encarga de repartir la carga entre los servidores (nodos) disponibles, y de que siempre haya en ejecuci√≥n lo que t√∫ quieres.</p><p>Por ejemplo, si un nodo falla y sus contenedores ya no est√°n disponibles, Kubernetes inicia nuevos contenedores en el resto de nodos para compensar la carga desaparecida.</p><h3 id=desplegando-nuestro-contenedor-en-kubernetes>Desplegando nuestro contenedor en Kubernetes.<a hidden class=anchor aria-hidden=true href=#desplegando-nuestro-contenedor-en-kubernetes>#</a></h3><p>Antes de continuar aseg√∫rate de que el contenedor de Docker ya no se est√° ejecutando.</p><p>En el episodio usamos VirtualBox como &ldquo;driver&rdquo; de minikube. O en otras palabras, minikube crear√° una m√°quina virtual con Linux en VirtualBox. En esa m√°quina virtual instalar√° Kubernetes, y sobre esa m√°quina virtual ejecutar√° los contenedores.</p><p>De esta forma evitamos instalar cosas raras en nuestro ordenador principal, y podemos hacer pruebas m√°s r√°pido.</p><p>En un entorno de producci√≥n lo m√°s normal es que instal√°semos Kubernetes sin una m√°quina virtual.</p><h4 id=iniciando-el-cluster-kubernetes>Iniciando el cluster Kubernetes<a hidden class=anchor aria-hidden=true href=#iniciando-el-cluster-kubernetes>#</a></h4><p>Para iniciar el cluster de Kubernetes hacemoss:</p><pre tabindex=0><code>minikube config set driver virtualbox
minikube start
</code></pre><p>Es posible que minikube se queje de que las instrucciones de virtualizaci√≥n no est√°n activadas. Si est√°s seguro de que est√°n activadas, puede que se trate de un bug, prueba usando la opci√≥n <code>--no-vtx-check</code> as√≠: <code>minikube start --no-vtx-check</code>.</p><h4 id=usando-un-repositorio-local>Usando un repositorio local<a hidden class=anchor aria-hidden=true href=#usando-un-repositorio-local>#</a></h4><p>Lo normal es que el ordenador en el que se desarrolla un contenedor, no sea el mismo en el que se ejecuta. Un desarrollador programa en su ordenador, pero luego se usa un servidor para desplegar en producci√≥n.</p><p>Por eso, lo normal es que las im√°genes de contenedores se guarden en repositorios, accesibles tanto al equipo de desarrollo como al servidor de producci√≥n.</p><p>Cuando pidamos a Kubernetes que despliege nuestra imagen, Kubernetes la buscar√° en uno de esos repositorios.</p><p>As√≠ que deber√≠amos publicar la imagen que hemos creado.</p><p>Peeeero, aqu√≠ estamos haciendo una prueba r√°pida. As√≠ que vamos a enga√±ar a Kubernetes para que cargue la imagen desde nuestro propio ordenador.</p><p>Para eso ejecutamos:</p><pre tabindex=0><code># En terminales unix
eval $(minikube docker-env)

# En windows PowerShell
minikube docker-env | Invoke-Expression
</code></pre><p>Y volvemos a construir la imagen:</p><pre tabindex=0><code>docker build -t my-php-app .
</code></pre><h3 id=desplegando-nuestra-im√°gen>Desplegando nuestra im√°gen<a hidden class=anchor aria-hidden=true href=#desplegando-nuestra-im√°gen>#</a></h3><p>Si ejecutamos:</p><pre tabindex=0><code>minikube dashboard
</code></pre><p>Se abrir√° en un navegador un escritorio de Minikube, donde podemos investigar qu√© est√° desplegado. √ösalo para ver c√≥mo afecta al cl√∫ster los siguientes comandos.</p><p>Podemos desplegar nuestra im√°gen con <code>kubectl run</code>:</p><pre tabindex=0><code>kubectl run test-php --image=my-php-app --image-pull-policy=Never --port=80
</code></pre><p>Donde:</p><ul><li><code>test-php</code> es el nombre del ojeto que se cree en Kubernetes.</li><li><code>--image</code> nos sirve para se√±alar la imagen a desplegar.</li><li><code>--image-pull-policy=Never</code> sirve para que descargue la imagen del repositorio local y no la busque en remoto.</li><li><code>--port=80</code> har√° que el puerto <code>80</code> que usa nuestra aplicaci√≥n est√© disponible en el contenedor.</li></ul><p>Ver√°s que se ha creado un <code>Pod</code> llamado <code>test-php</code>.</p><p>Para hacer accesible nuestra aplicaci√≥n fuera del cluster, tenemos que exponer el puerto <code>80</code> al exterior:</p><pre tabindex=0><code>kubectl expose pod test-php --type=NodePort --port=80
</code></pre><p>Ver√°s que se ha creado un <code>Service</code> llamado <code>test-php</code>.</p><p>Para probar la aplicaci√≥n, pon en un navegador la url que devuelve este comando:</p><pre tabindex=0><code>minikube service test-php --url
</code></pre><h2 id=otros-enlaces-de-inter√©s>Otros enlaces de inter√©s:<a hidden class=anchor aria-hidden=true href=#otros-enlaces-de-inter√©s>#</a></h2><ul><li><a href=https://www.docker.com/>https://www.docker.com/</a></li><li><a href=https://minikube.sigs.k8s.io/docs/start/>https://minikube.sigs.k8s.io/docs/start/</a></li><li><a href=https://semaphoreci.com/community/tutorials/dockerizing-a-php-application>https://semaphoreci.com/community/tutorials/dockerizing-a-php-application</a></li><li><a href=https://stackoverflow.com/questions/42564058/how-to-use-local-docker-images-with-minikube>https://stackoverflow.com/questions/42564058/how-to-use-local-docker-images-with-minikube</a></li></ul></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=http://localhost:1313/blog/01-capitulo-piloto/><span class=title>¬´ Prev</span><br><span>Capitulo piloto #1</span>
</a><a class=next href=http://localhost:1313/blog/013-2021-06-03---rompiendo-contenedores/><span class=title>Next ¬ª</span><br><span></span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=http://localhost:1313/>On The Nubs</a></span> ¬∑
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>